# C++常见崩溃问题分析

博客地址：[C++常见崩溃问题分析](https://blog.csdn.net/wd__900902/article/details/82918188)。
**注意**：该文章虽标明原创，但有相同却更早的文章可查，真实的原创原文已经不可考。主要参考该文章，是因为其代码比较完整。

## C++崩溃分类

|错误类型  |具体表现            |备注（案例）|
|:--------:|--------------------|------------|
|声明错误  |变量未声明          |编译时错误  |
|初始化错误|未初始化或初始化错误|运行不正确  |
|访问错误  |1.数组索引访问越界<br>2.指针对象访问越界<br>3.访问空指针对象<br>4.访问无效指针对象<br>5.迭代器访问越界||
|内存泄漏  |1.内存未释放<br>2.内存局部释放||
|参数错误  |本地代理、空指针、强制转换||
|堆栈溢出  |1.递归调用<br>2.循环调用<br>3.消息循环<br>4.大对象参数<br>5.大对象变量|参数、局部变量都在栈上分配|
|转换错误  |有符号类型和无符号类型转换||
|内存碎片  |小内存块重复分配释放导致的内存碎片，最后出现内存不足|数据对齐，机器字整数倍分配|

其他如内存分配失败、创建对象失败等都是容易理解和相对少见的错误，因为目前的系统大部分情况下内存够用；此外，除零错误也容易理解和防范。

<font color=blue>
注意，对于C++来说，浮点类型的除零并不是错误，会得到一个`inf`表示无限的值。
</font>

## C++编程回顾

> C/C++在内存空间管理方面添加了越来越多的自动化支持，简化了内存管理，然而简单并不意味着内存管理的复杂性消失，出现崩溃问题时我们一筹莫展正是因为简单性蒙蔽了我们的思维，而崩溃的根源就是内存空间的使用不当造成的，因此对操作系统原理、内存管理、语言语义的透彻理解是我们解决崩溃问题的关键所在。

### 进程内存布局
以Windows的资源管理器进程的内存布局视图为例：

|内存块英文名|中文名|详细说明|
|------------|------|--------|
|Image|映像内存|EXE、DLL等加载到这里|
|Mapped File|内存映射文件|共享内存，用于进程间通讯|
|Shareable|可共享内存||
|Heap(Managed Heap)|内存堆|堆内存，new/new[]/malloc等都在堆空间分配，默认为1MB；Managed Heap供CLR使用的堆|
|Stack|堆栈|栈内存，用做函数参数、局部变量的存储空间，默认为1MB|
|Private Data|私有数据||
|Page Table|内存页表|内存分配页表|
|Free|自由内存|可用的内存空间|

由于编译器在后台做了大量的内存管理自动化工作，因此程序设计过程中主要关注的内存区域类型有：Stack、Heap、Free(Free Virtual Address Space)，下面将进行简单介绍：

- Stack是一块固定大小的连续内存，受运行时管理，无需用户自行分配和回收；当函数调用嵌套层次非常深时会产生Stack Overflow（堆栈溢出）错误，如递归调用、循环调用、消息循环、大对象参数、大对象局部变量等都容易触发堆栈溢出；
- Heap主要用于管理小内存块，是一个内存管理单元，默认为1MB，可动态增长；每一个应用程序默认有一个Heap，用户也可以创建自己的Heap，new/delete、malloc/free都是从堆中直接分配内存块；
- Free (Free Virtual Address Space)即进程空间中整个可用地址空间，它会以两种方式被使用，一种是Heap自动分配和回收，一种是直接使用`VirtualAlloc*`/`VirtualFree*`分配和回收；用户对它直接使用是用于分配连续大块内存，分配和释放的速度比使用Heap更快。

### 字节序列
字节序列对于网络编程很重要，因为需要把数据包在本机字节序列和网络字节序列（大端序列）来回转换；使用`printf`和基于偏移量访问内存的操作也会遇到字节序的问题。

|端序|第一字节|中间字节|最末字节|备注|
|----|--------|--------|--------|----|
|大端（Big Endian）|最高位字节|……|最低位字节|类似于正常书写数字表示|
|小端（Little Endian）|最低位字节|……|最高位字节|类似数字计算法则，反序列|

端序的内存案例：

|端序|内存案例（0x44332211）|处理器家族|
|----|----------------------|----------|
|大端（Big Endian）|0x44 0x33 0x22 0x11|SUN SPARC/IBM PowerPC|
|小端（Little Endian）|0x11 0x22 0x33 0x44|Intel 80x86系列|


