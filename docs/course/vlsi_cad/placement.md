# Placement
分为两个部分：
- ASIC Placement思维导图
- 重点部分细节补充

## 🧠 ASIC Placement 思维导图

以下是DeepSeek根据课件整理的**ASIC Placement 思维导图（简洁版）**，涵盖课程 9.1 到 9.9 的核心内容：

### 1️⃣ **背景与目标**
- **输入**：门级网表（gates + wires）
- **输出**：每个门的位置$(x, y)$
- **目标**：最小化线长，确保可布线性

### 2️⃣ **标准单元库**
- 所有单元高度相同，宽度可变
- 每个单元是逻辑功能的几何抽象
- 库大小：多种逻辑、驱动强度、时序版本

### 3️⃣ **线长估计**
- **HPWL（半周长线长）**
  - 公式：$ΔX + ΔY$
  - 优点：简单、快速、下界估计
- 用于评估布局质量

### 4️⃣ **迭代改进布局**
- **随机初始布局**
- **随机交换门的位置**
- **贪心策略**：只接受线长变短的交换
- **问题**：容易陷入局部最优

### 5️⃣ **模拟退火布局**
- **核心思想**：允许偶尔接受变差的交换（爬坡）
- **接受概率**：$P = exp(-ΔL / T)$
- **温度 T** 从高到低缓慢下降
- **优点**：能跳出局部最优，结果更优
- **缺点**：速度慢，不适用于大规模设计

### 6️⃣ **解析布局（Analytical Placement）**
- **目标**：写出一个可最小化的数学函数
- **二次线长模型**：
  - 每对点之间用“弹簧”模型
  - 多端网用“clique”模型 + 权重 $1/(k-1)$
- **假设**：门为点，忽略尺寸（后续修正）

### 7️⃣ **二次布局求解**
- **矩阵形式**：$A·x = b
- **A 矩阵**：由连接矩阵 C 构造
- **b 向量**：由固定 Pad 位置和权重决定
- **求解**：稀疏、对称、正定矩阵，可用迭代法快速求解

### 8️⃣ **递归划分（Recursive Partitioning）**
- **问题**：二次布局不考虑门尺寸，可能重叠
- **解决方法**：
  - 按坐标排序，分配门到左右/上下区域
  - 用“伪 Pad”模拟外部连接
  - 递归划分直到区域门数较少

### 9️⃣ **合法化（Legalization）**
- 将门放入标准单元行，无重叠
- 可用局部交换（如小范围模拟退火）微调

!> 合法化这部分并没有实际讲解原理，只是简单提了下做法

### 🔚 **总结**
- 早期方法：迭代改进 → 模拟退火
- 现代方法：解析布局（如二次布局）+ 递归划分 + 合法化
- 核心挑战：平衡数学模型精度与物理可实现性

## 重点部分细节补充

以下是我认为比较重点的几处，让DeepSeek补充了细节。
1. 模拟退火布局的原理（伪代码）；
2. 二次布局求解中矩阵$A$和向量$b$的构造。

其中，第2点和Coursera上的第一个编程作业紧密相关。

---

## 🔥 模拟退火布局（Simulated Annealing Placement）的伪代码

- 输入：门级网表（gates + nets）
- 输出：每个门的最终位置$(x, y)$

1. 初始化
 - 随机放置所有门到网格中（每个网格位置最多一个门）
 - 计算初始总线长 $L = Σ HPWL$(每个网)
 - 设置初始温度 T = T_HOT（例如 $T = 800$）
 - 设置冻结标志 frozen = false

2. 主循环：退火过程
```
while (not frozen) {
    // 在每个温度下进行多次交换尝试
    // M 通常取 100 左右，表示每个门平均尝试交换的次数
    for (attempt = 1 to M * 门的总数) {
        
        // 随机选择两个门
        随机选择门 Gi
        随机选择门 Gj
        
        // 尝试交换它们的位置
        交换 Gi 和 Gj 的位置
        
        // 计算线长变化 ΔL
        // 注意：只计算受影响的网，增量式更新
        ΔL = 新总线长 - 旧总线长
        
        if (ΔL < 0) then
            // 情况1：线长变短 → 接受交换（贪心接受）
            保留这次交换
            更新总线长 L = L + ΔL
            
        else
            // 情况2：线长变长 → 以一定概率接受（爬坡）
            
            // 计算接受概率 P = exp(-ΔL / T)
            // ΔL 为正数，T 为当前温度
            P = exp(-ΔL / T)
            
            // 生成 [0,1) 之间的随机数
            r = random(0, 1)
            
            if (r < P) then
                // 接受变差的交换（爬坡）
                保留这次交换
                更新总线长 L = L + ΔL
            else
                // 拒绝交换，恢复原状
                撤销 Gi 和 Gj 的交换
            end if
        end if
    }
    
    // 完成当前温度下的所有尝试，降温
    // 检查是否应该继续降温
    if (总线长在过去几个温度下仍在显著下降) then
        T = 冷却系数 * T    // 通常冷却系数取 0.9
    else
        frozen = true      // 线长不再改善，冻结
    end if
}
```

3. 返回结果
 - 返回最终布局作为最佳解

### 📌 关键参数说明

| 参数 | 含义 | 典型值 |
|------|------|--------|
| `T_HOT` | 初始温度 | 800（根据问题规模可调） |
| `M` | 每个温度下每个门的平均交换次数 | 100 |
| 冷却系数 | 降温速率 | 0.9 |
| `ΔL` | 线长变化量 | 正数表示变差，负数表示变好 |
| `exp(-ΔL/T)` | 接受变差交换的概率 | ΔL 越小/T 越大，概率越高 |

### 🧠 核心思想

- **高温阶段**：接受变差交换的概率高 → 广泛搜索解空间，跳出局部最优
- **低温阶段**：接受变差交换的概率趋近于 0 → 局部精细优化
- **缓慢降温**：模拟物理退火过程，帮助找到接近全局最优的解

---

## 二次布局（Quadratic Placement）中矩阵 A 和向量 b 的具体构造方法

### 📐 二次布局的数学模型

二次布局的目标是最小化加权二次线长：
$$
min Φ(x, y) = Σ (权重 × 欧氏距离平方)
$$

由于 x 和 y 方向可分离，我们分别求解两个独立的线性系统：
$$
\begin{split}
A·x = b_x \\
A·y = b_y
\end{split}
$$

其中：
- $A$：N×N 矩阵（N 为可移动门的数量）
- $x, y$：N 维向量（门的待求坐标）
- $b_x, b_y$：N 维向量（由固定 Pad 位置决定）

## 🔧 矩阵$A$的构造方法

### 步骤1：构建连接矩阵$C$

首先构建 N×N 的连接矩阵$C$：
- 如果门$i$和门$j$之间有网（2-point net），且权重为$w$，则：
  $$
  C[i][j] = C[j][i] = w
  $$
- 如果没有直接连接，则：
  $$
  C[i][j] = 0
  $$

### 步骤2：从$C$构建$A$矩阵

A 矩阵的元素由以下规则确定：

**非对角线元素**（$i ≠ j$）：
$$
A[i][j] = -C[i][j]
$$

**对角线元素**（$i = j$）：
$$
A[i][i] = Σ_{j=1 to N} C[i][j] + (连接到 Pad 的权重之和)
$$
即：第$i$行的所有连接权重之和，再加上该门连接到固定 Pad 的所有权重。

### 步骤3：$A$矩阵的特性
- **对称**：$A[i][j] = A[j][i]$
- **稀疏**：每个门只与少数门相连
- **对角占优**：$|A[i][i]| ≥ Σ|A[i][j]| (j≠i)$
- **正定**：可高效求解

## 🎯 向量$b_x, b_y$的构造方法

$b$向量由**固定 Pad** 的位置和连接权重决定：

### 对于$b_x[i]$：
如果门$i$通过权重为$w$的网连接到坐标为$(x_p, y_p)$的固定 Pad p，则：
$$
b_x[i] += w × x_p
$$

### 对于$b_y[i]$：
如果门$i$通过权重为$w$的网连接到坐标为$(x_p, y_p)$的固定 Pad p，则：
$$
b_y[i] += w × y_p
$$

如果一个门连接到多个 Pad，则将所有贡献相加。

## 📝 完整构造示例

### 示例网表（3个门 + 1个Pad）

```
门：G1, G2, G3
Pad：P 固定在 (1.0, 0.5)

网1：G1 -- G2，权重 2
网2：G2 -- G3，权重 3
网3：G1 -- P，权重 4
```

### 步骤1：构建连接矩阵$C$

|   | G1 | G2 | G3 |
|---|---|---|---|
| G1 | 0  | 2  | 0  |
| G2 | 2  | 0  | 3  |
| G3 | 0  | 3  | 0  |

### 步骤2：构建$A$矩阵

对角线元素：
$$
\begin{split}
& A[1][1] = C[1][2] + (连接到 Pad 的权重) = 2 + 4 = 6\\
& A[2][2] = C[2][1] + C[2][3] = 2 + 3 = 5\\
& A[3][3] = C[3][2] = 3
\end{split}
$$

非对角线元素：
$$
\begin{split}
& A[1][2] = A[2][1] = -C[1][2] = -2\\
& A[2][3] = A[3][2] = -C[2][3] = -3\\
& A[1][3] = A[3][1] = 0
\end{split}
$$

最终 A 矩阵：
$$
A =
\begin{bmatrix}
6  & -2 &  0 \\
-2 &  5 & -3 \\
0  & -3 &  3
\end{bmatrix}
$$

### 步骤3：构建$b_x$向量

只有 G1 连接到 Pad P ($x_p = 1.0$, 权重 4)：
$$
\begin{split}
& b_x[1] = 4 × 1.0 = 4\\
& b_x[2] = 0\\
& b_x[3] = 0
\end{split}
$$

### 步骤4：构建$b_y$向量

Pad P 的$y_p = 0.5$：
$$
\begin{aligned}
& b_y[1] = 4 × 0.5 = 2\\
& b_y[2] = 0\\
& b_y[3] = 0
\end{aligned}
$$

### 步骤5：求解线性系统

求解$A·x = b_x$和$A·y = b_y$，得到所有门的位置。

## 💡 重要说明

1. **多端网处理**：$k$端网$(k>2)$用 **clique 模型** 转换为$k(k-1)/2$个 2 端网，每个权重为原网权重的$1/(k-1)$
2. **无 Pad 的门**：如果门没有连接到任何固定 Pad，则$b[i] = 0$
3. **求解方法**：由于$A$是稀疏正定矩阵，使用**迭代法**（如共轭梯度法）高效求解
4. **实际应用**：二次布局后需要递归划分和合法化来消除门重叠
