# ä¼˜åŒ–ç³»åˆ—ï¼ˆç¨‹åºå–µï¼‰ç¬”è®° - ç¬¬ä¸€ç¯‡ å·¥å…·ä¸“é¢˜

è¿™æ˜¯ä¸€ç¯‡é’ˆå¯¹[ç›®æ ‡æ–‡ç« ](https://mp.weixin.qq.com/s/WL-agdox7uNaPe4PV8HgQg)çš„ç¬”è®°ã€‚

è¯¥æ–‡ç« ä¸»è¦ä»‹ç»äº†ä¸€äº›ç”¨äºC++ä»£ç æ£€æŸ¥çš„å·¥å…·ã€‚

> å·¥å…·ä¸»è¦åˆ†ä¸º**é™æ€ä»£ç åˆ†æå·¥å…·**å’Œ**åŠ¨æ€ä»£ç æ£€æµ‹å·¥å…·**ã€‚

## é™æ€ä»£ç åˆ†æå·¥å…·

æ–‡ç« ä¸­åˆ—ä¸¾äº†ä¸€äº›é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œå…¶ä¸­æ¨èçš„æ˜¯**Clang-Tidy**ã€‚é™¤æ­¤ä¹‹å¤–æˆ‘æ¥è§¦è¿‡çš„è¿˜æœ‰**cppcheck**ã€‚å…¶ä»–å·¥å…·å› ä¸ºæ”¶è´¹å°±ç•¥è¿‡äº†ã€‚

è¿˜æåˆ°äº†SonarCubeä»£ç è´¨é‡ç®¡ç†å¹³å°ï¼Œå› ä¸ºæ²¡æœ‰æ¥è§¦è¿‡ï¼Œæœ‰å¾…ç ”ç©¶ã€‚

åœ¨Ubuntu18.04ï¼ˆWin10çš„WSL2ï¼‰ä¸­ï¼Œè¿™ä¸¤ä¸ªå·¥å…·éƒ½å¯ä»¥ç›´æ¥å®‰è£…ï¼š

```bash
sudo apt-get install cppcheck
sudo apt-get install clang-tidy clang
```

ä½¿ç”¨æ–¹æ³•éƒ½å¾ˆç®€å•ï¼ŒåŸºæœ¬å°±æ˜¯`cppcheck/clang-tidy` + [é…ç½®é€‰é¡¹] + [æºæ–‡ä»¶] å³å¯ã€‚ä½¿ç”¨ä¸€ä¸ªç®€å•çš„C++æ–‡ä»¶ï¼Œå†™ä¸€äº›é”™è¯¯çš„æƒ…å†µè¿›è¡Œæµ‹è¯•ï¼Œç¡®å®æ„Ÿè§‰clang-tidyçš„æç¤ºè¦æ›´åŠ è¯¦å°½ä¸€äº›ã€‚

> é™æ€ä»£ç åˆ†æå·¥å…·å¯ä»¥åœ¨è¿è¡Œå‰å¸®åŠ©æˆ‘ä»¬æ£€æµ‹ç¼ºé™·ï¼Œåªæœ‰30%-70%ï¼Œä½†ä¸æ˜¯æ‰€æœ‰ç¼ºé™·ï¼Œå¾ˆå¤šç¼ºé™·éœ€è¦åœ¨è¿è¡Œæ—¶æ‰ä¼šè¢«å‘ç°ã€‚

## åŠ¨æ€åˆ†æå·¥å…·

> é€šè¿‡åŠ¨æ€åˆ†æå·¥å…·å¯ä»¥å‡†ç¡®å®šä½é—®é¢˜ï¼Œè€Œä¸”è¯¯æŠ¥ç‡ä½ï¼Œä½†è¿™ä¸æµ‹è¯•ç”¨ä¾‹å¼ºç»‘å®šï¼ŒæŸ¥æ‰¾ç¼ºé™·çš„æ¯”ä¾‹ä¸æµ‹è¯•ç”¨ä¾‹çš„è¦†ç›–ç‡æœ‰å…³ï¼Œè¦†ç›–ç‡å¯¹äºè¡¡é‡ä»£ç è´¨é‡æœ‰å¾ˆå¤§æ„ä¹‰ã€‚

æˆ‘å¸åœ¨å»å¹´å¯¹ä»£ç è¿›è¡Œå®¡æŸ¥çš„æ—¶å€™ï¼Œä¹Ÿä½¿ç”¨çš„ä»£ç è¦†ç›–ç‡ï¼ˆCode Coverageï¼‰æ¥ä½œä¸ºè¯„ä»·çš„æŒ‡æ ‡ã€‚çš„ç¡®æµ‹è¯•ç”¨ä¾‹å¾ˆé‡è¦ï¼Œæµ‹ä¼¼ç”¨ä¾‹è¶³å¤Ÿå¤šæ ·ï¼Œæ‰èƒ½å¤Ÿè¦†ç›–åˆ°ä»£ç ä¸­çš„å„ç§æƒ…å†µï¼Œä»è€Œæ‰¾åˆ°ä»£ç ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜ã€‚æµ‹è¯•ç”¨ä¾‹è¿‡äºå•ä¸€æ—¶ï¼Œå¾ˆå¯èƒ½ä¼šè·³è¿‡å¤§å¤šæ•°ä»£ç ã€‚

> ä»£ç è¦†ç›–ç‡çš„æ„ä¹‰ï¼š
> - å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°æœªè¦†ç›–éƒ¨åˆ†çš„ä»£ç ï¼Œåˆ†ææµ‹è¯•ç”¨ä¾‹è®¾è®¡çš„æ˜¯å¦å……åˆ†ï¼Œä¹‹åè§†æƒ…å†µå†³å®šæ˜¯å¦å¯ä»¥è¡¥å……æµ‹è¯•ç”¨ä¾‹ã€‚
> - æ£€æµ‹å‡ºä»£ç çš„åå‘³é“ï¼Œæç¤ºæˆ‘ä»¬ä¿®æ”¹ä»£ç ï¼Œç†æ¸…ä»£ç é€»è¾‘å…³ç³»ï¼Œæå‡ä»£ç è´¨é‡ã€‚
> - ä»£ç è¦†ç›–ç‡é«˜ä¸èƒ½ä»£è¡¨ä»£ç è´¨é‡ä¸€å®šå¥½ï¼Œä½†ä»£ç è¦†ç›–ç‡ä½ï¼Œä»£ç è´¨é‡ä¼°è®¡ä¸ä¼šé«˜åˆ°å“ªå»ï¼Œå¯ä»¥ä½œä¸ºæˆ‘ä»¬è¡¡é‡ä»£ç è´¨é‡çš„é‡è¦æ‰‹æ®µä¹‹ä¸€ã€‚
> - å¯¹äºæ²¡æœ‰è¦†ç›–åˆ°çš„é”™è¯¯ï¼ŒåŠ¨æ€åˆ†æå·¥å…·ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨é™ç»“åˆï¼Œå¤šç§æ£€æŸ¥æ‰‹æ®µå…¨éƒ½ç”¨ä¸Šï¼Œå¯ä»¥æ›´æœ‰æ•ˆçš„æå‡ä»£ç è´¨é‡ã€‚ 

æ–‡ç« ä¸­æåˆ°çš„å·¥å…·æœ‰**GCC&Clangçš„Santizerç³»åˆ—**ï¼Œå’Œ**Valgrindå·¥å…·**ã€‚å¯¹äºSantizerç³»åˆ—æš‚ç•¥ï¼Œä¸»è¦çœ‹ä¸€ä¸‹Valgrindå·¥å…·ï¼š

> - memchekï¼šå†…å­˜é—®é¢˜ï¼ŒåŒ…æ‹¬Asanå’ŒMsan
> - helgrindï¼šçº¿ç¨‹å’Œå¹¶å‘é—®é¢˜
> - cachegrindã€callgrindã€massifï¼šå¸®åŠ©è¿›è¡Œæ€§èƒ½ä¼˜åŒ–

è¿™é‡Œä½¿ç”¨åŒä½œè€…ï¼ˆç¨‹åºå–µï¼‰çš„ä¸€ç¯‡æ–‡ç« [å°‘å†™ç‚¹if-elseå§ï¼Œå®ƒçš„æ•ˆç‡æœ‰å¤šä½ä½ çŸ¥é“å—ï¼Ÿ](https://mp.weixin.qq.com/s/m8avve1ahFrf8KJ0n2w8mA)ä¸­çš„ä»£ç æ¥æµ‹è¯•å·¥å…·ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```cpp
// test_predict.cc
#include <algorithm>
#include <ctime>
#include <iostream>

int main() {
    const unsigned ARRAY_SIZE = 50000;
    int data[ARRAY_SIZE];
    const unsigned DATA_STRIDE = 256;

    for (unsigned c = 0; c < ARRAY_SIZE; ++c) data[c] = std::rand() % DATA_STRIDE;

    std::sort(data, data + ARRAY_SIZE);

    {  // æµ‹è¯•éƒ¨åˆ†
        clock_t start = clock();
        long long sum = 0;

        for (unsigned i = 0; i < 100000; ++i) {
            for (unsigned c = 0; c < ARRAY_SIZE; ++c) {
                if (data[c] >= 128) sum += data[c];
            }
        }

        double elapsedTime = static_cast<double>(clock() - start) / CLOCKS_PER_SEC;

        std::cout << elapsedTime << "\n";
        std::cout << "sum = " << sum << "\n";
    }
    return 0;
}
```

é€šè¿‡ä¿ç•™/æ³¨é‡Š`std::sort()`è¿™ä¸€è¡Œæ¥åˆ†åˆ«æ£€æŸ¥ç¨‹åºä¸­çš„åˆ†æ”¯é¢„æµ‹æƒ…å†µï¼Œè¿è¡Œç»“æœçš„å·®å¼‚ï¼š

![è¿è¡Œç»“æœ](note/result.jpg)

ä»£ç ä¸­é—®é¢˜å¾ˆæ˜æ˜¾ï¼Œå¦‚æœæ•°æ®ç»è¿‡æ’åºï¼ŒåŒé‡å¾ªç¯ä¸­çš„ifåœ¨é¢„æµ‹æ—¶æ­£ç¡®ç‡ä¼šå˜é«˜ï¼ˆæ•°æ®æœ‰åºï¼Œåˆ™å‰ä¸€éƒ¨åˆ†éƒ½æ˜¯falseè€Œåé¢å…¨æ˜¯trueï¼‰ï¼›è‹¥æœªæ’åºåˆ™å¾ˆéš¾é¢„æµ‹ä¸‹ä¸€ä¸ªæ•°æ®çš„æƒ…å†µã€‚

> CPUéƒ½æ˜¯å¤šçº§æµæ°´çº¿æ¶æ„è¿è¡Œï¼Œå¦‚æœåˆ†æ”¯é¢„æµ‹æˆåŠŸï¼Œå¾ˆå¤šæŒ‡ä»¤éƒ½æå‰è¿›å…¥æµæ°´çº¿æµç¨‹ä¸­ï¼Œåˆ™æµæ°´çº¿ä¸­æŒ‡ä»¤è¿è¡Œçš„éå¸¸é¡ºç•…ï¼Œè€Œå¦‚æœåˆ†æ”¯é¢„æµ‹å¤±è´¥ï¼Œåˆ™éœ€è¦æ¸…ç©ºæµæ°´çº¿ä¸­çš„é‚£äº›é¢„æµ‹å‡ºæ¥çš„æŒ‡ä»¤ï¼Œé‡æ–°åŠ è½½æ­£ç¡®çš„æŒ‡ä»¤åˆ°æµæ°´çº¿ä¸­æ‰§è¡Œï¼Œç„¶è€Œç°ä»£CPUçš„æµæ°´çº¿çº§æ•°éå¸¸é•¿ï¼Œåˆ†æ”¯é¢„æµ‹å¤±è´¥ä¼šæŸå¤±10-20ä¸ªå·¦å³çš„æ—¶é’Ÿå‘¨æœŸï¼Œå› æ­¤å¯¹äºå¤æ‚çš„æµæ°´çº¿ï¼Œå¥½çš„åˆ†æ”¯é¢„æµ‹æ–¹æ³•éå¸¸é‡è¦ã€‚

åŸæ–‡ä¸­æ˜¯ä½¿ç”¨å·¥å…·`perf`æ¥å±•ç¤ºä¸¤ç§æƒ…å†µä¸‹çš„åˆ†æ”¯é¢„æµ‹ç»“æœï¼Œä½¿ç”¨valgrindå·¥å…·ï¼š

```bash
valgrind --tool=cachegrind ./test_predict
```

è¿›è¡Œäº†æ’åºçš„ç»“æœï¼š

![è¿›è¡Œäº†æ’åº](note/test_predict.jpg)

æ²¡æœ‰è¿›è¡Œæ’åºçš„ç»“æœï¼š

![æ²¡è¿›è¡Œæ’åº](note/test_predict_no.jpg)

å¥½åƒå¹¶æ²¡æœ‰çœ‹åˆ°æ˜æ˜¾çš„å·®åˆ«ï¼Œå¯èƒ½æ˜¯å°†æ’åºçš„ä»£ä»·ä¹Ÿç®—è¿›å»äº†ï¼ŸğŸ˜…

### Valgrindå·¥å…·ç›¸å…³

Valgrindå·¥å…·åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæŠ¥é”™`error calling PR_SET_PTRACER, vgdb might block`ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºç¨‹åºå¦‚æœåœ¨ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ä¸­é˜»å¡ï¼Œéœ€è¦vgdbæ¥å”¤é†’ï¼Œä½¿ç”¨çš„é€”å¾„å°±æ˜¯`PR_SET_PTRACER`ï¼›æ¢è¨€ä¹‹å¦‚æœç¨‹åºä¸ä¼šåœ¨syscallä¸­é˜»å¡ï¼Œåˆ™ä¸ä¼šå‡ºé—®é¢˜(StackOverflowä¸Šçš„å›ç­”ï¼Œå‚è€ƒæ–‡ç« 4)ã€‚ä¼¼ä¹æ–°ç‰ˆæœ¬çš„WSL2å·²ç»ä¿®å¤äº†è¯¥é—®é¢˜ã€‚

å¯¹äºValgrindå·¥å…·çš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒä¸€ç¯‡ä¸“æ ï¼š[éƒ­è€äºŒ-GDB](https://blog.csdn.net/u010168781/category_6998350.html)

## å‚è€ƒæ–‡ç« 
1. [clang-tidyä½¿ç”¨](https://blog.csdn.net/u013187057/article/details/103052275)
2. [æ·±å…¥ç ”ç©¶Clang(åä¸‰) clang-tidyç®€ä»‹](https://zhuanlan.zhihu.com/p/102248131)
3. [Valgrindå‘½ä»¤](https://blog.csdn.net/hbhhww/article/details/7168507)
4. [Valgrind showing error calling `pr_set_ptracer`, vgdb might block](https://stackoverflow.com/questions/57206233/valgrind-showing-error-calling-pr-set-ptracer-vgdb-might-block)
